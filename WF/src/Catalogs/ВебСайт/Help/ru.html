<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"><html><head><meta content="text/html;charset=utf-8" http-equiv="content-type"></meta><link rel="stylesheet" type="text/css" href="v8help://service_book/service_style"></link><meta name="GENERATOR" content="MSHTML 11.00.10570.1001"></meta></head><body>
<h1>Веб-сайт</h1>
<p>Этот справочник предназначен для хранения информации о логике работы публикуемого веб-сайта по протоколу HTTP. Доступ к веб-сайту публикуемому из 1с, пользователь имеет по ссылке <a href="http://адрес_сервера_1с.ru/имя_публикации/hs/lk/">http://адрес_сервера_1с.ru/имя_публикации/hs/lk/</a><br>Где <em>адрес_сервера_1с</em> - это имя сервера где установлен сервер 1С, либо HTTP-адрес сервера<br><em>имя_публикации</em> - имя под которым вы опубликовали конфигурацию.</p>
<h2>Алгоритм работы веб-сайта</h2>
<p><br>Пользователи входят в браузере по ссылке выше, HTML-страницы формируются автоматически, анализируя запрос от пользователя. Т.е. если пользователь введет адрес или перейдет в веб-сайт по ссылке, например: <a href="http://адрес_сервера_1с.ru/имя_публикации/hs/lk/folder1/folder2/file.html?param=1"><font color="#0066cc">http://адрес_сервера_1с.ru/имя_публикации/hs/lk/folder1/folder2/file.html?param=1</font></a><br>То для построения страницы пользователю система выполнит следующий алгоритм:<br>Все, что после lk, т.е. /folder1/folder2/file.html?param=1 будет разбито на блоки и по шагам выполнено:</p>
<ol><li>Будет выполнена проверка, включена ли на публикуемом сайте авторизация. Если в проекте присутствует страница с признаком "СтраницаАвторизации", система посчитает что авторизация включена, предположим что авторизация откючена, и разберем механизм её работы позже. 
</li><li>В справочнике "Веб-сайт" будет предпринята попытка найти папку folder1 в корне справочника, далее если это путь длинный, то будет попытка найти следующую папку. 
</li><li>Путь длинный, встретили folder2 в пути, ищем внутри папки foler1 папку folder2. 
</li><li>Если папка folder2 будет найдена, то далее в этой папке будет попытке найти элемент file.html 
</li><li>Если на шагах 1-3 не будет что-то найдено, то пользователю будет показана страница с признаком "Страница404" (страница не найдена) и при этом процесс будет остановлен. Если же файл будет найден в иерархии, то этот шаг игнорируется. 
</li><li>С найденным элементом на шаге 3  - если этот файл картинка, то она будет отправлена пользователю по HTTP с кодом 200 (страница найдена) и процесс остановлен, если это страница html, то возьмем текст с вкладки "Основные данные" справочника "Веб-сайт" - этот текст будет основой для будущей странички, назовем этот текст "шаблон". А текстовые данные с закладки "Алгоритм обработки" назовем "алгоритм". 
</li><li>Берем шаблон и проверим его на наличие фрагментов вида &lt;!---include(path/to/file.html)---&gt;. Этот фрагмент означает, что необходимо вместо него вставить файл, который находится по адресу в справочнике веб-сайт "path/to/file.html". Полученный после замены текст будет новым шаблоном. 
</li><li>Теперь возьмем алгоритм и выполним его встроенной командой Выполнить(Алгоритм) на языке 1С. В этом алгоритме можно использовать переменные: 
<ol><li>Тело - строка, HTML-шаблон страницы, если он не используется берется алгоритм; 
</li><li>Переменные - структура, куда могут быть помещены свои значения и использоваться при построении страниц, по умолчанию содержит элементы с ключами "BASE_URL" и "БазовыйURL", которые содержат в себе базовый URL обрабатываемого запроса; 
</li><li>Запрос - объект HTTP-запрос, который выполнил пользователь в браузере; 
</li><li>Ответ - объект HTTP-ответ, который мы можем переопределить; 
</li><li>ОтносительныйURL - строка, путь вида folder1/folder2/file.html из примера; 
</li><li>ОтносительныйURLПеренаправления - строка, если определить эту переменную, то вместо вывода чего-то пользователю будет дан ответ с кодом 302 (перенаправление на другу страницу) и в этой переменной указывается адрес страницы перенаправления; 
</li><li>ИмяФайла - строка, имя файла из примера (т.е. file.html); 
</li><li>Путь - строка, путь к файлу из примера (folder1/folder2/); 
</li><li>ЭтоPOST - булево, если вызван http-метод "GET" - ложь, "POST" - истина. 
</li><li>ПараметрыЗапроса - структура, содержащая в себе параметры запроса, ключ - имя параметра, значение - строка со значением параметра, при переходе по ссылке из примера будет содержать в себе элемент "param"-"1". 
</li><li>АвторизованныйПользователь - ссылка на элемент справочника "ПользователиВебСайта", если пользователь авторизован и для сайта включен механизм авторизации, или неопределено.</li></ol></li><li>После выполнения алгоритма можем получить обновленный шаблон документа, который далее автоматически будет проанализирован. 
</li><li>Проверяем шаблон на то, что он содержит фрагменты текста вида &lt;!---MY_TEXT---&gt;, которые могли быть внесены выполнение алгоритма и если такие фрагменты содержатся, то будет предпринята попытка поиска в глобальной структуре "Переменные " строки с ключем "MY_TEXT". Если MY_TEXT будет найдена, то вместо &lt;!---MY_TEXT---&gt; будет вставлено то, что будет указано в "Переменные". Полученный после замены текст будет готовым HTML-документом. 
</li><li>Готовый HTML-документ будет показан пользователю. Это и будет готовая страничка.</li></ol><p>Важно понимать, что если в теле HTML-документа вы добавите, например, картинку вида &lt;img src="/path/to/picture.png"&gt;, то текст будет показан, а браузер при следующем обращении увидит, что надо показать картинку и запросит у вас по пути "/path/to/picture.png" эту картинку, но это уже будет следующим запросом! Т.е. отдавать что-то другое отличное от ОтносительныйURL не надо! Это будет сделано автоматически.</p>
<h2>Механизм авторизации </h2>
<p><br>Для возможности реализации авторизации в публикуемом проекте были добавлены реквизиты справочника "ВебСайт" значение которых определяет роль страницы, справочник "ПользователиВебСайта" и общий модуль "ВебСайт_АвторизацияРегистрация", который содержит в себе процедуры и функции авторизации и регистрации.</p>
<p>Специальные реквизиты справочника "ВебСайт":</p>
<ol><li>"СтраницаАвторизации" - булево, в справочнике может быть только один элемент с этим признаком, если такой элемент есть, считается что для публикуемого веб-сайта включена авторизация. При попытке получить доступ к любой странице без признака "СтраницаДоступноБезАвторизации", пользователь будет перенаправлятся на страницу с признаком "СтраницаАвторизации". Авторизация считается пройденной, когда пользователю в браузер установлен cookie с ключём "token", значение которого совпадает со значением реквизита "Токен" одного из элементов справочника "ПользователиВебСайта". Для прохождения авторизации необходимо использовать функцию "ВебСайт_АвторизацияРегистрация.ВыполнитьАвторизациюПользователя(Логин, Пароль, Запрос,Ответ)". В параметр "Логин" и "Пароль" передавать введенные пользователем на веб-странице учетные данные(можно получить через переменную "ПараметрыЗапроса" в алгоритме обработки страницы), в параметр "Запрос - обрабатываемый запрос(переменная "Запрос"), в параметр "Ответ" - формируемый ответ(переменная "Ответ"). Если авторизация пройдена успешно - формируемый ответ переопределяется на ответ с кодом "302"(перенаправление) на страницу с признаком "СтраницаОсновная", в заголовок ответа помещается команда на установку cookie "token", функция возвращает ссылку на авторизованого пользователя. Если авторизация не пройдена, функция возвращает "Неопределено" и не переопределяет объект "Ответ". 
</li><li>"СтраницаДоступноБезАвторизации" - булево, при запросе страницы с этим признаком не выполняется переадресация на страницу авторизации, даже если в проекте включена автортизация. Можно использовать например для страницы регистрации. Для регистрации можно использовать функцию "ВебСайт_АвторизацияРегистрация.ВыполнитьРегистрациюПользователя(Логин)". Если в справочнике "ПользователиВебСайта" нет элемента с передаваемым логином, будет создан новый элемент, сгенерирован пароль, и функция вернет ссылку на нового пользователя, если пользователь с переданным логином существует - неопределено. 
</li><li>"Страница404" - булево, при запросе страницы которой нет в проекте, пользователю будет возвращаться страница с этим признаком. 
</li><li>"СтраницаОсновная" - булево, после авторизации будет осуществлятся перенаправление на эту страницу.</li></ol><p>Для отмены авторизации, например организации кнопки выхода из личного кабинета можно использовать процедуру "ВебСайт_АвторизацияРегистрация.УдалитьДанныеОбАвторизации(Запрос,Ответ)" - в процедуре переопределяется HTTPОтвет на перенаправление на основную страницу, в заголовок устанавливается команда очистки значения cookie "token".</p>
<h2>Хранение данных веб-сайта в макете</h2>
<p><br>Для возможности переноса публикуемого рещения в расширение, без потери данных при переподключении расшрения добавлена возможность хранить описания страниц в макете табличного документа. Для импорта данных необходимо в форме списка справочника "ВебСайт" нажать на кнопку "Импорт/экспорт", в открывшемся окне переключить тумблер в значение "Выгрузка в макет", и нажать на кнопку "Выполнить". Сформированный табличный документ скопировать в макет "ШаблоныСтраниц" обработки "ВебСайта_Шаблоны". Для переключения на получение данных из шаблона в общем модуле "ВебСайт_HTTPСервисы" в функции "ВебСайтХранитсяВМакете()" изменить возвращаемое значение на "Истина".</p></body></html>